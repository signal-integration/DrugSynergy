---
title: "X+Y analysis using random forests"
output: html_document
---

<br />
#### Simulating mean expression for a given integration profile
<br />
Here we generate numerical values (e_0, e_X, e_Y, e_X+Y) representing a given profile. 


```{r message = FALSE, warning = FALSE}
source("compute_profile_means.R")
source("setPowerPointStyle.R")
setPowerPointStyle()

#reading the profile definitions
PROFCODES = read.table("profile_codes_v2.txt",header = TRUE,sep = "\t") 

#this file encodes the system of equalities/inequalities that we want to solve
load("constraints_vector")

prof_index = 2 #index of the profile we want to simulate
ntimes = 1000 #n. of simulations
exp_min = 2 #min range of expression value
exp_max = 16 #max range of expression value
min_delta = 0.5 #minimum non-zero difference among any two comparisons

profile_means = compute_profile_means(PROFCODES, prof_index, ntimes, 
                                      exp_min, exp_max, 
                                      constraints_vector, min_delta)

colnames(profile_means)=c("0","X","Y","X+Y")
head(profile_means)
```


#### Plotting one example
```{r message = FALSE, warning = FALSE}
source("setPowerPointStyle.R")
setPowerPointStyle()

barplot(profile_means[1,-5], ylab = 'simulated expression')
delta_x = profile_means[1,2] - profile_means[1,1]
delta_y = profile_means[1,3] - profile_means[1,1]
add = profile_means[1,1] + delta_x + delta_y
abline(h = add, col="black")
```


#### Simulating random samples for a given inegration profile
After computing the means for a given profile, we can generate random samples resembling real data. We assume that real data come from normal distributions centered around the means computed above. The standard deviation is passed as a parameter, so it is possible to simulate  arbitrary noise levels.

```{r results='hide', message=FALSE, warning=FALSE}
source("simulate_from_means.R")
source("setPowerPointStyle.R")
setPowerPointStyle()

samples = 4 #number of samples for each condition that will be simulated

signal_to_noise = 3

#noise_level = 0.5 #this means that the signal-to-noise is delta/noise_level = 1/0.5

design = factor(c(rep("CTRL", samples), rep("X", samples), rep("Y", samples), rep("Y+X", samples)))

simulated_values = simulate_from_means(profile_means[1,], samples,
                                       signal_to_noise, exp_min, exp_max)
names(simulated_values) = design

boxplot(simulated_values ~ design, ylab = 'simulated expression', col = 'gray')

#stripchart(simulated_values ~ design, vertical = TRUE, 
#    method = "jitter", add = TRUE, pch = 20, col = 'black',cex #= 1.5)

```





Example with more noise.
```{r results = 'hide', message = FALSE, warning = FALSE}
source("setPowerPointStyle.R")
setPowerPointStyle()

signal_to_noise = 1 #this means that the signal-to-noise is delta/noise_level = 1/1

simulated_values = simulate_from_means(profile_means[1,], samples,
                                       signal_to_noise, exp_min, exp_max)

boxplot(simulated_values ~ design, ylab = 'simulated expression', 
        col = 'gray')

stripchart(simulated_values ~ design, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'black',cex=1.5)

```


#### Extracting statistical features from a noisy input
Let's assume we have a noisy input in the form of N replicates of 0,X, Y, X+Y. We derive a set of statistical features, which will be used as predictors of the true profile in the  classifier. Such features consist of: the Bliss index, the mean expression values in 0,X, Y, X+Y, and the p-values for all possible pairwise tests. We consider both one-tailed, and two-tailed tests of t-test and Wilkoxon. In total, the are 75 variables. These statistical features are computed with the function *match11* as shown below. 

```{r warning = FALSE}
source("extract_stat_features.R")

profile_features = extract_stat_features(simulated_values, design)
length(profile_features)
head(profile_features, 10)
```


### Analyzing a dataset

```{r warning = FALSE}
#data_file = "GSE75003.txt"
data_file = "tnf_ifn_1_v3"
my_data = read.csv(data_file)
#my_data = read.csv(data_file,sep = '\t')
head(my_data)

```

```{r warning=FALSE}
#graphical parameters
source("setPowerPointStyle.R")
setPowerPointStyle()

expression_data = my_data[,-(1:2)]
expression_data = expression_data[-which(apply(expression_data, 1, sd) == 0), ]

if (max(expression_data)>25) expression_data = log2(expression_data)

my.pca <- prcomp(t(expression_data), center = TRUE, scale = TRUE)

#we assume the same number of samples for each condition
samples = ncol(expression_data)/4

cols = c(rep("black", samples), rep("red", samples),
         rep("blue", samples), rep("yellow", samples))

plot(my.pca$x[, 1], my.pca$x[, 2], col = cols,
     xlab = "PC1", ylab = "PC2", pch = 20, cex = 1.5, main = data_file)

legend("bottomleft", pch = 20, col = unique(cols), 
       legend = c("0","X","Y","X+Y"), bty = 'n',cex = 1)
```




### Applying the classification algorithm
```{r warning = FALSE, message = FALSE}
source("resolve_integration.R")
source("filter_results.R")

#load("classifiers")
#rf_model = classifiers[[3]]

load("rf_model")

PROFCODES = read.table("profile_codes_v2.txt", header = TRUE,sep = "\t") 

#read data file
file_name = "tnf_ifn_1_v3"

combinatorial_data = read.csv(file_name)

samples = ncol(combinatorial_data[,-(1:2)])/4
design = factor(c(rep("CTRL", samples), 
                  rep("X", samples), 
                  rep("Y", samples), 
                  rep("YX", samples)))

results = resolve_integration(combinatorial_data, design, PROFCODES)

#filter results
filtered_results = filter_results(results, adjusted_pval = 0.05)


#show frequencies of interactions
outcomes = table(filtered_results[[1]]$type)
outcomes = outcomes[c(2,3,1)]


png(file="interactions_barplot.png", width = 200, height = 200)
setPowerPointStyle()
barplot(outcomes, names.arg = c("ant", "syn", "add"), col = c("red", "blue", "gray70"), horiz = T, las = 1,
        xlab = 'gene frequency', xlim = c(0, 780))#, xaxt="n")
text(outcomes[1] + 100, 0.7, outcomes[1])
text(outcomes[2] + 100, 1.9, outcomes[2])
text(outcomes[3] + 100, 3.2, outcomes[3])

dev.off()


#visualize_all_profiles(filtered_results[[1]])

#visualize individual genes
em = filtered_results[[1]][filtered_results[[1]]$prof_index == 22,]

#sort by fc
em = em[order(-em$min_fc), ]
k = 1
gene_profile = as.numeric(em[k,3:14])
plot(gene_profile ~ design, main = em[k,2], ylab = 'log2(expr)', xlab = '')
stripchart(gene_profile ~ design, vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'black',
    cex = 1.5)


#save(filtered_results, file = "results_1h")
```


```{r warning = FALSE, message = FALSE}

#load("results_1h")

library(eulerr)

venn_df = filtered_results[[2]][,c(18, 19, 21)]

venn_df[venn_df == -1] = 1
names(venn_df) = c("\U0394IFN", "\U0394TNF", "\U0394IFN+TNF")
plot(euler(venn_df), quantities = T)

```


### alluvial plot
```{r warning = FALSE, message = FALSE}
library(reshape2)
source("generate_ocean_plot.R")
deg = filtered_results[[1]]

generate_ocean_plot(deg)

```

```{r warning = FALSE, message = FALSE}
library(enrichR)
library(ggplot2)
source("cluster_annotation_terms.R")

deg = filtered_results[[1]]
deg$genes = as.character(deg$genes)

all_dbs = listEnrichrDbs()$libraryName
dbs <- all_dbs[c(117, 94, 95, 93, 101)]

joined = cluster_annotation_terms(deg, 'P', dbs, n = 20)


#here get terms enriched using all synergies
joined_f_all = filter(joined, ratio >= 0.1 & gene_set =='all')

joined_f_all$Term = factor(joined_f_all$Term)

ggplot(joined_f_all, aes(x = gene_set, y = Term)) +geom_point(aes(size = ratio, fill = score), shape = 21) + scale_radius(breaks = seq(0.05, 0.5, by = 0.1), range = c(4,10)) +  scale_fill_gradientn(limits = c(2,15), colours=c("navyblue", "darkmagenta", "darkorange1")) +
theme_bw() + theme(text = element_text(size=12, face = 'bold'), panel.border = element_blank()) + scale_y_discrete(limits = rev(levels(joined_f_all$Term)[c(2,3,1)]), expand = c(1, 2, 25))


joined_f_others = filter(joined, ratio >= 0.1 & gene_set !='all')

selected_terms = joined_f_others$Term[c(1, 7, 12, 14, 19, 25, 26, 41, 45)]

joined_f_others_s = filter(joined_f_others, Term %in% selected_terms)

joined_f_others_s$Term = factor(joined_f_others_s$Term)


ggplot(joined_f_others_s, aes(x = gene_set, y = Term)) +geom_point(aes(size = ratio, fill = score), shape = 21) + scale_radius(breaks = seq(0.05, 0.5, by = 0.1), range = c(4,10)) +  scale_fill_gradientn(limits = c(1.6,15.6), colours=c("navyblue", "darkmagenta", "darkorange1")) +
theme_bw() + theme(text = element_text(size=12, face = 'bold'), panel.border = element_blank()) +
scale_y_discrete(limits = rev(levels(joined_f_others_s$Term)[c(2,3,4,1,8,9,7,5)]), expand = c(1, 2, 25))



joined_f_all$split_var = 'all syn'
joined_f_others_s$split_var = 'landscape'


test = rbind(joined_f_all, joined_f_others_s)

test$Term[1] = 'Neg reg of transcription' 
test$Term[2] = 'Cytokine signaling'
test$Term[3] = 'Immune system'
test$Term[4] = 'Immune system'
test$Term[5] = 'IFN signaling'
test$Term[6] = 'Immune system'
test$Term[7] = 'ISG15 antiviral mechanism'
test$Term[8] = 'MHC-1 mediated antigen processing'
test$Term[9] = 'Pos regul of activated T cell prolif'
test$Term[10] = 'TNF signaling pathway'
test$Term[11] = 'Regulation of TLR signalling'
test$Term[12] = 'Mineral absorption'
test$Term[13] = 'Metabolism'

test$Term = factor(test$Term)


ggplot(test, aes(x = gene_set, y = Term)) +geom_point(aes(size = ratio, fill = score), shape = 21) + scale_radius(breaks = seq(0.05, 0.5, by = 0.1), range = c(4,10)) +  scale_fill_gradientn(limits = c(1.6,15.6), colours=c("navyblue", "darkmagenta", "darkorange1")) +
theme_bw() + facet_grid(.~split_var, scales = "free", drop = TRUE)+theme(text = element_text(size=12, face = 'bold'), panel.border = element_blank())+theme(panel.spacing = unit(1.5, "lines"))+
scale_y_discrete(limits = rev(levels(test$Term)[c(3,1,8,2,4,6,11,10,9,7,5)]))




```


```{r warning = FALSE, message = FALSE}
library(enrichR)
library(ggplot2)
source("cluster_annotation_terms.R")

deg = filtered_results[[1]]

#remove low-value synergies
deg$genes = as.character(deg$genes)

#deg = deg[deg$prof_index != 7, ]
#deg = deg[deg$prof_index != 14, ]


#choose annotation databases
all_dbs = listEnrichrDbs()$libraryName
dbs <- all_dbs[c(117, 94, 95, 93, 101)]

#regulation
#dbs <- all_dbs[c(1)]

joined = cluster_annotation_terms(deg, 'P', dbs, n = 20)

#joined$Term = make.names(joined$Term, unique = T)
#joined = joined[joined$gene_set != 'high-val', ]

binary = cast(joined, Term ~ gene_set)
binary[is.na(binary)] = 0
binary[,-1] = t(apply(binary[,-1], 1, function(x) x>0))

names(binary)[2] = 'all syn'
names(binary)[3] = 'case 1'
names(binary)[4] = 'case 4a'
names(binary)[5] = 'case 4b'
plot(euler(binary[,-1]), quantities = T, fill = c("white", "green", "yellow", "orange"), fill_alpha = 0.7)


#binary[which(binary$`case 4b` == TRUE), ]


ggplot(joined, aes(x = gene_set, y = Term)) +
geom_point(aes(size = ratio, fill = score), shape = 21) +
scale_size_area(max_size = 10) + scale_fill_gradient(low = "gray70", high = "black")  + theme_bw() + 
theme(text = element_text(size=10, face = 'bold'))


joined_f = joined[joined$ratio >= 0.1, ]

joined_f_all = joined_f[joined_f$gene_set =='all', ]
  
ggplot(joined_f_all, aes(x = gene_set, y = Term)) +
geom_point(aes(size = ratio, fill = score), shape = 21) + scale_size_area(max_size = 10) + scale_y_discrete(expand = c(1, 3, 5)) +  theme_bw() + theme(text = element_text(size=10, face = 'bold'), panel.border = element_blank())



joined_f_others = joined_f[joined_f$gene_set !='all', ]


joined_f_others_s = filter(joined_f_others, 
                  joined_f_others$Term == joined_f_others$Term[1] |
                  joined_f_others$Term == joined_f_others$Term[7] |  
                  joined_f_others$Term == joined_f_others$Term[12]
|  
                  joined_f_others$Term == joined_f_others$Term[14]
|  
                  joined_f_others$Term == joined_f_others$Term[19]
|  
                  joined_f_others$Term == joined_f_others$Term[25]
|  
                  joined_f_others$Term == joined_f_others$Term[26]
|  
                  joined_f_others$Term == joined_f_others$Term[41]

|  
                  joined_f_others$Term == joined_f_others$Term[45]
)


joined_f_others_s$Term = factor(joined_f_others_s$Term)


joined_f_others_s$Term = factor(joined_f_others_s$Term, levels = plot_order_levels)



ggplot(joined_f_others_s, aes(x = gene_set, y = Term)) +geom_point(aes(size = ratio, fill = score), shape = 21) + scale_radius(breaks = seq(0.02, 0.5, by = 0.1), range = c(4,10)) +  scale_fill_gradientn(limits = c(2,15), colours=c("navyblue", "darkmagenta", "darkorange1")) +
theme_bw() + theme(text = element_text(size=12, face = 'bold'), panel.border = element_blank()) +
scale_y_discrete(limits = levels(joined_f_others_s$Term)[rev(c(2,3,4,1,8,9,7,5))])





ggplot(joined_f_all, aes(y = ratio, x = Term, fill = score)) + geom_bar(stat = 'identity')+coord_flip()


ggplot(joined_f_all, aes(x = gene_set, y = Term)) +
geom_point(aes(size = ratio, fill = score), shape = 21) +
scale_size_area(max_size = 10) + scale_fill_gradient(low = "gray70", high = "black")  + theme_bw() + 
theme(text = element_text(size=10, face = 'bold'))





joined_f_all
test = rbind(joined_f_all, joined_f[which(joined_f$gene_set == 1)[1:3], ])

test = rbind(test, joined_f[which(joined_f$gene_set == 4)[1:3], ])


ggplot(test, aes(y = ratio, x = Term, fill = score)) + geom_bar(stat = 'identity')+coord_flip() + facet_grid(gene_set ~.)



#get three most enriched pathways for each gene list
#my_set = joined[joined$gene_set == '1', ]
#my_set[order(-my_set$score)[1:20], ]
#barplot_classes =  my_set[c(1, 3, 5), ]
#barplot_classes = rbind(barplot_classes, my_set[])
#ggplot(data=j, aes(x=Term, y=score)) +
#    geom_bar(stat="identity") +
#  coord_flip() + facet_grid(gene_set ~.)




library(dplyr)

joined_f = filter(joined, 
                  joined$Term == joined$Term[21] |
                  joined$Term == joined$Term[42] |  
                  joined$Term == joined$Term[65] |
                  joined$Term == joined$Term[74] |
                  joined$Term == joined$Term[79] |
                  joined$Term == joined$Term[85] |
                  joined$Term == joined$Term[86] |
                  joined$Term == joined$Term[14] |
                  joined$Term == joined$Term[29]  )


joined_f$Term = factor(joined_f$Term)

plot_order_levels = levels(joined_f$Term)[c(7,6,4,2,1,5,8,3)]

joined_f$Term = factor(joined_f$Term, levels = plot_order_levels)
  

ggplot(joined_f, aes(x = gene_set, y = Term))+
  geom_point(aes(size = ratio, fill = score), shape = 21)+ 
  scale_size_area(max_size = 12) + scale_fill_gradient(low = "gray70", high = "black") +
  theme_bw() + 
theme(text = element_text(size=12, face="bold"))


ggsave(plot = p, width = 5.5, height = 3.5, dpi = 400, filename = "not squished axis.png")


prof_3 = results[[3]][,22]

names_entrez = bitr(names(prof_3), fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

#prof_3_s_GSEA = prof_3_s
#names(prof_3_s_GSEA) = add_entrez$ENTREZID

a = data.frame(prof_3, results[[1]]$genes)
names(a) = c("score", "SYMBOL")
a1 = merge(a, names_entrez, by = 'SYMBOL')

gsea_vector = a1$score
names(gsea_vector) = a1$ENTREZID
gsea_vector = sort(gsea_vector, decreasing = T)


#egmt2 <- GSEA(gsea_vector, TERM2GENE=c5, verbose=FALSE)
#head(egmt2)

ego3 <- gseKEGG(geneList     = gsea_vector,
              #OrgDb        = org.Hs.eg.db,
              #ont          = "BP",
              nPerm        = 1000,
              minGSSize    = 100,
              maxGSSize    = 500,
              pvalueCutoff = 0.95,
              verbose      = FALSE)


entrez = strsplit(ego3@result[5, ]$core_enrichment, '/')[[1]]

bitr(entrez, fromType="ENTREZID", toType="SYMBOL", OrgDb="org.Hs.eg.db")


plot(as.numeric(deg[deg$genes == 'MT1E', 3:14])~design)


```



### enrichment with clusterProfiler
```{r warning = FALSE, message = FALSE}
library(clusterProfiler)
#remove low-value synergies
deg = deg[deg$prof_index != 7, ]
deg = deg[deg$prof_index != 14, ]



add_entrez = bitr(names(prof_3), fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")



add_entrez = bitr(deg[deg$type == 'A', 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

syn_entrez = bitr(deg[deg$type == 'P', 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

ant_entrez = bitr(deg[deg$type == 'N', 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

clusters = list(syn_entrez$ENTREZID, ant_entrez$ENTREZID)

#clusters = list(add_entrez$SYMBOL, syn_entrez$SYMBOL, ant_entrez$SYMBOL)

names(clusters) = c('syn', 'ant')

ck <- compareCluster(geneCluster = clusters, fun = "enrichKEGG", pvalueCutoff = 0.1)
dotplot(ck, showCategory = 1)

ck <- compareCluster(geneCluster = clusters, fun = "enrichGO", OrgDb = "org.Hs.eg.db", ont = 'CC', pvalueCutoff = 0.1)
dotplot(ck, showCategory = 1)







syn_entrez = bitr(deg[deg$type == 'P', 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

syn1_entrez = bitr(deg[deg$type == 'P' & deg$case == 1, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

syn2_entrez = bitr(deg[deg$type == 'P' & deg$case == 4, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

syn3_entrez = bitr(deg[deg$type == 'P' & deg$case == 5, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

syn4_entrez = bitr(deg[deg$type == 'P' & deg$case == 8, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

syn5_entrez = bitr(deg[deg$type == 'P' & deg$case == 9, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

clusters1 = list(syn_entrez$ENTREZID, 
                syn1_entrez$ENTREZID,
                syn2_entrez$ENTREZID,
                syn3_entrez$ENTREZID,
                syn4_entrez$ENTREZID,
                syn5_entrez$ENTREZID)

#clusters = list(add_entrez$SYMBOL, syn_entrez$SYMBOL, ant_entrez$SYMBOL)

names(clusters1) = c('all_syn', '1', '4a', '4b', '5a', "5b")

ck <- compareCluster(geneCluster = clusters, fun = "enrichKEGG", pvalueCutoff = 0.05)
dotplot(ck, showCategory = 5)


ck <- compareCluster(geneCluster = clusters, fun = "enrichGO", OrgDb = "org.Hs.eg.db", ont = 'BP', pvalueCutoff = 0.01)
dotplot(ck, showCategory = 2)

ck <- compareCluster(geneCluster = clusters, fun = "enrichGO", OrgDb = "org.Hs.eg.db", ont = 'CC', pvalueCutoff = 0.05)
dotplot(ck, showCategory = 5)





ant_entrez = bitr(deg[deg$type == 'N', 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

ant1_entrez = bitr(deg[deg$type == 'N' & deg$case == 1, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

ant2_entrez = bitr(deg[deg$type == 'N' & deg$case == 4, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

ant3_entrez = bitr(deg[deg$type == 'N' & deg$case == 5, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

ant4_entrez = bitr(deg[deg$type == 'N' & deg$case == 6, 'genes'], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")

clusters2 = list(ant_entrez$ENTREZID, 
                ant1_entrez$ENTREZID,
                ant2_entrez$ENTREZID,
                ant3_entrez$ENTREZID,
                ant4_entrez$ENTREZID)

names(clusters2) = c('all_ant', 'a', 'b', 'c', 'd')



ck <- compareCluster(geneCluster = c(clusters1, clusters2), fun = "enrichGO", OrgDb = "org.Hs.eg.db", ont = 'BP', pvalueCutoff = 0.1)
dotplot(ck, showCategory = 1)


ck <- compareCluster(geneCluster = c(clusters1, clusters2), fun = "enrichKEGG", pvalueCutoff = 0.2)
dotplot(ck, showCategory = 2)




dbs <- c("Reactome_2016", "WikiPathways_2016", "KEGG_2016")
enriched <- enrichr(ant4_entrez$SYMBOL, dbs)

```




```{r warning = FALSE, message = FALSE}

type_1h = as.character(my_results_1h$type)
type_1h[my_results_1h$prof_index == 2] = 'const'

type_2.5h = as.character(my_results_2.5h$type)
type_2.5h[my_results_2.5h$prof_index == 2] = 'const'

alluvial_df = melt(table(type_1h, type_2.5h))
alluvial_df = alluvial_df[-which(alluvial_df$type_1h == 'const' & alluvial_df$type_2.5h == 'const'),]
alluvial(alluvial_df[,1:2], freq = alluvial_df$value)


type_1h = as.character(my_results_1h$prof_index)
type_1h[my_results_1h$prof_index == 2] = 'const'

type_2.5h = as.character(my_results_2.5h$prof_index)
type_2.5h[my_results_2.5h$prof_index == 2] = 'const'

alluvial_df = melt(table(type_1h, type_2.5h))
alluvial_df = alluvial_df[-which(alluvial_df$type_1h == 'const' & alluvial_df$type_2.5h == 'const'),]
alluvial_df = alluvial_df[alluvial_df$value > 40, ]
alluvial(alluvial_df[,1:2], freq = alluvial_df$value, hide = 
           alluvial_df$value < 50)




#here transitions
prof_freq_1h = rep(0, 123)
names(prof_freq_1h) = 1:123
prof_freq_1h[names(table(my_results_1h$prof_index))] = table(my_results_1h$prof_index)
prof_freq_1h = prof_freq_1h/sum(prof_freq_1h)

prof_freq_2.5h = rep(0, 123)
names(prof_freq_2.5h) = 1:123
prof_freq_2.5h[names(table(my_results_2.5h$prof_index))] = table(my_results_2.5h$prof_index)
prof_freq_2.5h = prof_freq_2.5h/sum(prof_freq_2.5h)

alluvial_df[,1]

```


```{r warning = FALSE, message = FALSE}


alluvial_cases = melt(table(deg$type, deg$case))
#alluvial_cases = alluvial_cases[alluvial_cases$value > 20, ]

col = as.character(alluvial_cases$Var.1)
col[col == 'A'] = 'gray60'
col[col == 'N'] = 'red'
col[col == 'P'] = 'blue'

alluvial_cases$Var.1 = factor(alluvial_cases$Var.1, levels(alluvial_cases$Var.1)[c(1,3,2)])
levels(alluvial_cases$Var.1)[levels(alluvial_cases$Var.1) =="P"] <- "syn"
levels(alluvial_cases$Var.1)[levels(alluvial_cases$Var.1) == "A"] <- "add"
levels(alluvial_cases$Var.1)[levels(alluvial_cases$Var.1)=="N"] <- "ant"

alluvial(alluvial_cases[,c(1,2)], freq = alluvial_cases$value, col = col, cex = 0.1, alpha=0.7)


alluvial(alluvial_cases[,c(1,2)], freq = alluvial_cases$value, col = col, cex = 0.1, alpha=0.7)


annotation = as.character(alluvial_cases$Var1)
annotation[annotation == 'A'] = 'IFN pathway'
annotation[annotation == 'N'] = 'RNA polymerase'
annotation[annotation == 'P'] = 'TNF'
  
alluvial_cases = add_column(alluvial_cases, Var3 = annotation, .after = 1)


alluvial(alluvial_cases[,1:3], freq = alluvial_cases$value, col = col)
```
